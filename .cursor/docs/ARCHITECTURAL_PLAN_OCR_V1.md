# Архитектурный план реализации OCR системы для PDF документов

## Общий контекст проекта

**Ключевые требования для OCR системы:**
- Работа с отсканированными PDF документами (растровые изображения в PDF формате)
- Использование локальных vision моделей Ollama для распознавания текста
- Интеграция с существующей системой react-pdf для построения DOM дерева текста
- Автоматическое определение типа PDF (текстовый или сканированный)
- Сохранение структуры и координат текста для корректного отображения в TextLayer
- Поддержка различных vision моделей Ollama (llava, gemma3, qwen3-vl и др.)
- Оптимизация производительности для больших PDF документов
- Интеграция с существующими функциями PDF Viewer (перевод, инструкции)

## Анализ текущей архитектуры

### Существующие компоненты для интеграции

**React Frontend (FSD Architecture):**
- `pdf-viewer.tsx` - компонент для просмотра PDF с использованием react-pdf
- `react-pdf` с `pdfjs-dist` для рендеринга PDF и создания TextLayer
- Система выделения текста через `collectTextNodes` и TreeWalker
- Интеграция с `useModel` для перевода и инструкций
- Redux store для управления состоянием элементов и провайдеров

**Electron Backend (Service Layer Architecture):**
- `OllamaApi` для HTTP взаимодействия с LLM моделями с поддержкой streaming
- `DocumentProcessorService` для обработки PDF документов
- `PDFUtils` для анализа структуры PDF и извлечения текста
- IPC система с `IpcHandler` для унифицированной обработки запросов
- Система сервисов: ollama-manager, model-catalog
- FileSystemService с поддержкой различных типов файлов

**Технические детали:**
- react-pdf использует pdfjs для рендеринга PDF страниц
- TextLayer создается автоматически при наличии текста в PDF
- pdfjs предоставляет `getTextContent()` для извлечения текста со страниц
- Ollama поддерживает vision модели через `/api/generate` с массивом `images` (base64)
- Vision модели могут обрабатывать изображения и возвращать текстовые описания

## Архитектурный план реализации

## Этап 1: Создание инфраструктуры OCR системы

### 1.1 Установка и настройка зависимостей для OCR
**Цель:** Установить необходимые библиотеки для извлечения изображений из PDF и работы с vision моделями Ollama.

**Задачи:**
- Установить `pdfjs-dist` (если еще не установлен) для работы с PDF на бэкенде
- Установить `canvas` или `sharp` для обработки изображений страниц PDF
- Установить `pdf-lib` или использовать существующий `pdf-parse` для извлечения изображений из PDF
- Установить соответствующие TypeScript типы для всех библиотек
- Настроить конфигурацию сборки для корректной работы с нативными модулями (canvas)
- Обеспечить совместимость с существующей системой сборки Electron
- Добавить необходимые dev-зависимости для разработки и тестирования
- Проверить совместимость с существующими зависимостями проекта

**Ожидаемый результат:** Полностью настроенная среда для дальнейшей разработки с всеми необходимыми зависимостями OCR системы.

### 1.2 Создание типов для OCR системы
**Цель:** Создать полный набор типизированных интерфейсов для OCR системы.

**Задачи:**
- Создать файл типов `electron-app/src/types/ocr.ts` с интерфейсами для OCR системы включая `OCRRequest` с путем к PDF файлу или буфером, идентификатором документа, настройками OCR, `OCRResponse` с распознанным текстом, массивом страниц с текстом и координатами, метаданными обработки, `OCRPageResult` с номером страницы, распознанным текстом, массивом текстовых блоков с координатами, уровнем уверенности, `OCRTextBlock` с текстом, координатами (x, y, width, height), размером шрифта, семейством шрифта, `OCRProcessingProgress` для отслеживания прогресса обработки включая этап обработки, номер текущей страницы, общее количество страниц, процент выполнения, `OCRConfig` с настройками OCR включая модель vision, параметры обработки изображений, настройки качества, `PDFImageExtractionResult` с массивом изображений страниц, метаданными страниц, `OCRModelInfo` с информацией о vision модели включая название, поддерживаемые форматы, максимальный размер изображения
- Создать файл типов `react-app/src/shared/types/ocr.ts` с интерфейсами для frontend включая `OCRStatus` для статуса OCR обработки, `OCRPageData` для данных страницы с OCR текстом, `OCRTextLayerData` для данных TextLayer с координатами
- Интегрировать типы с существующей системой типов проекта
- Обеспечить типобезопасность всех операций OCR

**Ожидаемый результат:** Полный набор типизированных интерфейсов для OCR системы с интеграцией в существующую систему типов проекта.

### 1.3 Создание сервиса извлечения изображений из PDF
**Цель:** Создать сервис для извлечения изображений страниц из PDF документов для последующей обработки vision моделями.

**Задачи:**
- Создать файл `electron-app/src/services/pdf-image-extractor.ts` с классом `PDFImageExtractorService`
- Реализовать метод `extractPageImages` для извлечения изображений всех страниц PDF документа
- Реализовать метод `extractSinglePageImage` для извлечения изображения конкретной страницы
- Реализовать метод `convertPageToImage` для конвертации PDF страницы в изображение (PNG/JPEG) с настройками качества и разрешения
- Реализовать метод `detectPDFType` для определения типа PDF (текстовый, сканированный, смешанный) на основе наличия текста в TextLayer
- Добавить поддержку различных форматов изображений для OCR (PNG, JPEG) с оптимизацией размера
- Реализовать обработку ошибок извлечения изображений с детальным логированием
- Обеспечить поддержку больших PDF документов с потоковой обработкой по страницам
- Добавить прогресс-индикаторы для длительных операций извлечения изображений
- Реализовать кэширование извлеченных изображений для избежания повторной обработки
- Добавить оптимизацию размера изображений для уменьшения времени обработки vision моделями
- Реализовать поддержку различных DPI для извлечения изображений с балансом между качеством и размером

**Ожидаемый результат:** Полнофункциональный сервис извлечения изображений из PDF с поддержкой различных форматов и оптимизацией производительности.

## Этап 2: Интеграция с Ollama для OCR

### 2.1 Расширение OllamaApi для поддержки vision моделей
**Цель:** Расширить существующий OllamaApi для поддержки vision моделей и обработки изображений для OCR.

**Задачи:**
- Расширить типы в `electron-app/src/types/ollama.ts` для поддержки vision моделей включая `OllamaVisionRequest` с текстовым промптом, массивом изображений в base64, моделью vision, параметрами генерации, `OllamaVisionResponse` с распознанным текстом, метаданными обработки, уровнем уверенности, `OllamaVisionConfig` с настройками для различных vision моделей
- Модифицировать файл `electron-app/src/services/ollama-api.ts` для добавления поддержки vision моделей
- Реализовать метод `generateVision` для генерации текста из изображений через Ollama API с поддержкой различных vision моделей
- Реализовать метод `generateVisionBatch` для батчевой обработки множественных изображений
- Добавить валидацию параметров запроса для vision моделей
- Добавить поддержку различных vision моделей с автоматическим определением возможностей
- Обеспечить совместимость с существующими методами генерации текста
- Добавить логирование операций с vision моделями для отладки
- Реализовать оптимизацию запросов для уменьшения нагрузки на Ollama
- Обеспечить корректную обработку streaming ответов для vision моделей
- Реализовать обработку ошибок vision моделей с retry логикой
- Добавить поддержку различных форматов изображений (PNG, JPEG, WebP)
- Реализовать автоматическое определение оптимальной vision модели из доступных

**Ожидаемый результат:** Расширенный OllamaApi с полной поддержкой vision моделей и оптимизацией для OCR задач.

### 2.2 Создание сервиса OCR с интеграцией Ollama
**Цель:** Создать сервис для обработки OCR запросов с использованием vision моделей Ollama.

**Задачи:**
- Создать файл `electron-app/src/services/ocr-service.ts` с классом `OCRService`
- Реализовать инициализацию сервиса с подключением к существующему `OllamaApi` и `PDFImageExtractorService`
- Реализовать метод `processPDF` для обработки PDF документа с автоматическим определением типа и применением OCR при необходимости
- Реализовать метод `processPage` для обработки отдельной страницы PDF с извлечением изображения и отправкой в vision модель
- Реализовать метод `extractTextFromImage` для извлечения текста из изображения через vision модель с настройкой промпта для OCR
- Реализовать метод `parseOCRResponse` для парсинга ответа vision модели и извлечения структурированного текста с координатами
- Реализовать метод `buildTextLayerData` для построения данных TextLayer из распознанного текста с сохранением координат
- Добавить кэширование результатов OCR для избежания повторной обработки
- Реализовать обработку ошибок OCR с fallback логикой
- Добавить логирование операций OCR для отладки
- Обеспечить совместимость с различными vision моделями
- Реализовать оптимизацию памяти для работы с большими PDF документами
- Добавить валидацию входных данных для предотвращения ошибок
- Реализовать поддержку различных языков OCR через настройку промпта
- Добавить метрики производительности для мониторинга операций OCR
- Реализовать автоматическую оптимизацию параметров в зависимости от vision модели

**Ожидаемый результат:** Полнофункциональный сервис OCR с интеграцией в OllamaApi и поддержкой различных vision моделей.

### 2.3 Создание утилит для работы с OCR
**Цель:** Создать утилиты для обработки и оптимизации OCR результатов.

**Задачи:**
- Создать файл `electron-app/src/utils/ocr.ts` с утилитами для работы с OCR
- Реализовать функцию `normalizeOCRText` для нормализации распознанного текста с исправлением типичных ошибок OCR
- Реализовать функцию `calculateTextCoordinates` для вычисления координат текста на основе ответа vision модели
- Реализовать функцию `mergeOCRResults` для объединения результатов OCR нескольких страниц
- Реализовать функцию `validateOCRResponse` для проверки корректности ответа OCR
- Реализовать функцию `optimizeImageForOCR` для оптимизации изображений перед отправкой в vision модель
- Реализовать функцию `buildOCRPrompt` для построения промпта для vision модели с учетом языка и типа документа
- Добавить кэширование результатов вычислений для оптимизации производительности
- Реализовать обработку ошибок с fallback механизмами
- Добавить логирование операций для отладки
- Обеспечить совместимость с различными vision моделями
- Реализовать оптимизацию памяти для работы с большими объемами OCR данных
- Добавить валидацию входных данных для предотвращения ошибок
- Реализовать поддержку различных форматов OCR результатов
- Обеспечить совместимость с существующей системой управления моделями
- Добавить метрики производительности для мониторинга операций OCR
- Реализовать автоматическую оптимизацию параметров в зависимости от vision модели

**Ожидаемый результат:** Набор утилит для эффективной работы с OCR, оптимизированных для производительности.

## Этап 3: Создание IPC API для OCR системы

### 3.1 Создание IPC обработчиков для OCR с обновлением preload скрипта и типов
**Цель:** Создать IPC API для взаимодействия frontend с OCR системой через безопасный preload скрипт с полной типизацией.

**Задачи:**
- Создать файл `electron-app/src/presentation/ipc/ocr-handlers.ts` с обработчиками для OCR операций
- Использовать существующий `IpcHandler.createHandlerWrapper` для унифицированной обработки ошибок и логирования
- Реализовать обработчик `ocr:process-pdf` для обработки PDF документа с автоматическим определением типа и применением OCR
- Реализовать обработчик `ocr:process-page` для обработки отдельной страницы PDF с OCR
- Реализовать обработчик `ocr:detect-pdf-type` для определения типа PDF (текстовый, сканированный, смешанный)
- Реализовать обработчик `ocr:get-ocr-progress` для получения прогресса OCR обработки
- Реализовать обработчик `ocr:cancel-processing` для отмены текущей OCR обработки
- Добавить валидацию входных данных для всех обработчиков с детальными сообщениями об ошибках
- Реализовать обработку ошибок файловой системы и OCR сервиса
- Добавить детальное логирование всех операций OCR для отладки и мониторинга
- Обеспечить атомарность операций с документами и OCR обработкой
- Модифицировать файл `electron-app/src/preload.ts` для добавления OCR API
- Добавить объект `ocr` в `contextBridge.exposeInMainWorld('electron')` с методами для обработки OCR
- Реализовать метод `processPDF` для обработки PDF документа с OCR с прогресс-индикатором
- Реализовать метод `processPage` для обработки отдельной страницы с OCR
- Реализовать метод `detectPDFType` для определения типа PDF документа
- Реализовать метод `onOCRProgress` для подписки на события прогресса OCR обработки
- Реализовать метод `cancelProcessing` для отмены текущей OCR обработки
- Использовать `ipcRenderer.invoke` для асинхронного взаимодействия с main процессом
- Обновить файл типов `electron-app/src/types/preload.ts` для добавления типов OCR в интерфейс `ElectronAPI`
- Создать модуль `electron-app/src/services/ocr.ts`
- Добавить метод ocr.processPDF(pdfFile: File, config: OCRConfig): Promise<OCRResult> для обработки PDF
- Добавить метод ocr.processPage(pdfFile: File, pageNumber: number, config: OCRConfig): Promise<OCRPageResult> для обработки страницы
- Добавить метод ocr.detectPDFType(pdfFile: File): Promise<PDFType> для определения типа PDF
- Добавить метод ocr.onOCRProgress(callback): () => void для событий прогресса
- Добавить метод ocr.cancelProcessing(): Promise<void> для отмены обработки
- Определить интерфейс OCRRequest с полями filePath: string, config: OCRConfig
- Определить интерфейс OCRResult с полями success: boolean, pages: OCRPageResult[], totalPages: number
- Определить интерфейс OCRPageResult (уже в ocr.ts)
- Определить интерфейс OCRProgress с полями stage: 'extracting' | 'processing' | 'parsing', currentPage: number, totalPages: number, progress: number, message: string
- Определить интерфейс PDFType с значениями 'text' | 'scanned' | 'mixed'
- Импортировать типы из electron-app/src/types/ocr.ts
- Следовать структуре интерфейса ElectronAPI из electron-app/src/types/preload.ts
- Определить OCRError с полями type: 'extraction' | 'processing' | 'parsing' | 'model', message: string, details?: unknown

**Ожидаемый результат:** Полнофункциональный IPC API для OCR системы с унифицированной обработкой ошибок, логированием и полной типизацией в preload скрипте.

### 3.2 Создание функциональности тестирования OCR IPC API через UI
**Цель:** Создать модуль с функциями тестирования OCR системы и интегрировать в существующий React компонент.

**Задачи:**
- Создать IPC API клиент OCR системы `react-app/src/shared/apis/ocr-ipc/ocr-ipc.ts`, на подобии `react-app/src/shared/apis/rag-ipc/rag-ipc.ts`
- Добавить индексный файл API клиента OCR системы `react-app/src/shared/apis/ocr-ipc/index.ts`
- Добавить типы API клиента OCR системы `react-app/src/shared/apis/ocr-ipc/types/ocr-ipc.ts`
- Создать модуль для тестирования полного функционала OCR системы с использованием API клиента OCR системы, на подобии `react-app/src/widgets/settings/tests/chat-ipc.ts`
- Интегрировать в `react-app/src/widgets/settings/ui/tests.tsx` кнопки вызова тестовых функций

**Ожидаемый результат:** Полностью функциональная группа модулей которая позволяет протестировать OCR систему через UI.

## Этап 4: Интеграция OCR с PDF Viewer

### 4.1 Создание UI для выбора vision модели OCR
**Цель:** Создать пользовательский интерфейс (попап) для выбора vision модели OCR с интеграцией в существующую систему настроек.

**Задачи:**
- Модифицировать `react-app/src/widgets/settings/ui/manage-embedded-ollama.tsx` по SOLID что бы можно было выбирать не только модели для общения и эмбеддингов, но и vision модели для OCR, нужно что бы из Settings можно было открыть отдельный попап, в котором можно выбрать/загрузить/удалить vision модели для OCR системы
- Интегрировать выбор vision модели OCR в существующую систему настроек провайдеров
- Интегрировать компонент `ManageModels` для выбора vision модели OCR в `react-app/src/widgets/settings/ui/settings.tsx`
- Добавить валидацию совместимости выбранной vision модели с OCR системой
- Реализовать правильную цепочку прокидывания названия vision модели для работы с выбранной моделью на бэкенде, добавив дополнительный аргумент config в соответствующие функции IPC API
- Добавить индикацию доступности vision моделей с проверкой через Ollama API
- Реализовать автоматическое определение vision моделей из списка доступных моделей Ollama

**Ожидаемый результат:** Полнофункциональный UI для выбора vision модели OCR, интегрированный в существующую систему.

### 4.2 Расширение PDF Viewer для поддержки OCR
**Цель:** Интегрировать OCR функциональность в существующий PDF Viewer с автоматическим определением типа PDF и применением OCR при необходимости.

**Задачи:**
- Модифицировать файл `react-app/src/widgets/pdf-viewer/ui/pdf-viewer.tsx` для добавления OCR функциональности
- Реализовать состояние `ocrStatus` для отслеживания статуса OCR обработки
- Реализовать состояние `ocrTextLayerData` для хранения данных TextLayer из OCR
- Создать обработчик `detectPDFType` для определения типа загруженного PDF документа
- Реализовать автоматическое определение необходимости OCR на основе типа PDF
- Создать обработчик `processPDFWithOCR` для обработки PDF с OCR при обнаружении сканированного документа
- Реализовать интеграцию OCR результатов с react-pdf TextLayer через кастомный рендерер
- Добавить прогресс-индикатор OCR обработки в интерфейс PDF Viewer
- Реализовать отображение статуса OCR обработки с информацией о прогрессе
- Добавить переключатель для ручного включения/выключения OCR режима
- Реализовать кэширование OCR результатов для избежания повторной обработки
- Обеспечить корректную работу существующих функций PDF Viewer с OCR текстом
- Добавить обработку ошибок OCR с информативными сообщениями
- Реализовать поддержку частичной OCR обработки (только выбранные страницы)
- Добавить настройки OCR включая выбор vision модели, качество обработки
- Обеспечить адаптивность интерфейса OCR для различных размеров экрана
- Добавить анимации обработки OCR для улучшения пользовательского опыта
- Реализовать автоматическое обновление TextLayer при завершении OCR обработки
- Обеспечить совместимость OCR текста с существующими функциями выделения и перевода

**Ожидаемый результат:** Полнофункциональный PDF Viewer с интегрированной OCR системой и автоматическим определением типа PDF.

### 4.3 Создание кастомного TextLayer рендерера для OCR
**Цель:** Создать кастомный рендерер TextLayer для отображения OCR текста с сохранением координат и структуры.

**Задачи:**
- Создать файл `react-app/src/widgets/pdf-viewer/ui/ocr-text-layer.tsx` для кастомного TextLayer рендерера
- Реализовать компонент `OCRTextLayer` для отображения OCR текста с координатами
- Реализовать функцию `buildTextLayerFromOCR` для построения структуры TextLayer из OCR результатов
- Реализовать функцию `mapOCRToTextItems` для маппинга OCR текстовых блоков в формат TextLayer items
- Реализовать функцию `calculateTextPositions` для вычисления позиций текста на основе координат OCR
- Добавить поддержку различных размеров шрифта и семейств шрифтов из OCR результатов
- Реализовать корректное позиционирование текста относительно PDF страницы
- Обеспечить совместимость с существующим TextLayer react-pdf
- Добавить обработку ошибок рендеринга OCR TextLayer
- Реализовать оптимизацию производительности рендеринга больших объемов OCR текста
- Добавить поддержку выделения OCR текста через существующую систему выделения
- Обеспечить корректную работу с существующими функциями перевода OCR текста

**Ожидаемый результат:** Полнофункциональный кастомный TextLayer рендерер для OCR текста с сохранением координат и совместимостью с существующими функциями.

## Этап 5: Оптимизация и производительность

### 5.1 Оптимизация обработки изображений для OCR
**Цель:** Оптимизировать процесс извлечения и обработки изображений из PDF для уменьшения времени OCR обработки.

**Задачи:**
- Реализовать оптимизацию размера изображений перед отправкой в vision модель с балансом между качеством и размером
- Реализовать батчевую обработку изображений для уменьшения количества запросов к Ollama
- Реализовать параллельную обработку страниц PDF для ускорения OCR обработки
- Добавить кэширование извлеченных изображений для избежания повторной обработки
- Реализовать сжатие изображений с сохранением качества для OCR
- Добавить поддержку различных DPI для оптимизации времени обработки
- Реализовать прогрессивную загрузку OCR результатов (показывать результаты по мере обработки)
- Добавить мониторинг использования памяти при обработке больших PDF документов
- Реализовать автоматическую очистку памяти при завершении OCR обработки
- Добавить ограничения на размер обрабатываемых PDF для предотвращения проблем с памятью

**Ожидаемый результат:** Оптимизированная система обработки изображений для OCR с улучшенной производительностью и управлением памятью.

### 5.2 Оптимизация запросов к Ollama для OCR
**Цель:** Оптимизировать запросы к Ollama vision моделям для уменьшения времени обработки и нагрузки на систему.

**Задачи:**
- Реализовать оптимизацию промптов для vision моделей с учетом специфики OCR задач
- Реализовать батчевую обработку запросов к Ollama для уменьшения количества HTTP запросов
- Добавить кэширование результатов OCR для избежания повторных запросов
- Реализовать retry логику с экспоненциальной задержкой для обработки ошибок
- Добавить поддержку streaming ответов для отображения прогресса OCR обработки
- Реализовать оптимизацию параметров запросов в зависимости от vision модели
- Добавить мониторинг производительности запросов к Ollama
- Реализовать автоматическое определение оптимальной vision модели из доступных
- Добавить поддержку различных форматов изображений с автоматическим выбором оптимального
- Реализовать обработку таймаутов и длительных операций

**Ожидаемый результат:** Оптимизированная система запросов к Ollama для OCR с улучшенной производительностью и надежностью.

## Этап 6: Управление жизненным циклом OCR системы

### 6.1 Интеграция с системой управления файлами и очистка ресурсов
**Цель:** Интегрировать OCR систему с существующей системой управления файлами и реализовать корректную очистку ресурсов.

**Задачи:**
- Модифицировать файл `electron-app/src/services/filesystem.ts` для интеграции с OCR системой
- Реализовать метод `saveOCRResults` для сохранения результатов OCR обработки
- Реализовать метод `loadOCRResults` для загрузки сохраненных результатов OCR
- Реализовать метод `clearOCRCache` для очистки кэша OCR результатов
- Добавить автоматическое сохранение OCR результатов при обработке PDF
- Реализовать синхронизацию между файловой системой и OCR кэшем
- Добавить валидацию целостности сохраненных OCR результатов
- Модифицировать файл `electron-app/src/main.ts` для добавления очистки OCR ресурсов
- Реализовать метод `cleanupOCRResources` для очистки всех ресурсов OCR системы
- Добавить очистку временных файлов и кэша при завершении работы
- Реализовать сохранение состояния OCR системы для корректного восстановления при перезапуске
- Добавить мониторинг использования памяти OCR системой с логированием
- Реализовать автоматическую очистку неиспользуемых OCR результатов
- Добавить обработку ошибок при очистке ресурсов с детальным логированием
- Обеспечить корректное завершение всех активных операций OCR перед очисткой

**Ожидаемый результат:** Полностью интегрированная система управления жизненным циклом OCR данных с существующей файловой системой и надежная система управления ресурсами OCR с корректной очисткой.

### 6.2 Создание системы мониторинга и логирования OCR
**Цель:** Создать комплексную систему мониторинга и логирования для OCR системы.

**Задачи:**
- Создать файл `electron-app/src/utils/ocr-monitoring.ts` для мониторинга OCR системы
- Реализовать сбор метрик производительности включая время обработки PDF документов, время OCR обработки страниц, время запросов к Ollama
- Реализовать мониторинг использования памяти и дискового пространства OCR системой
- Добавить логирование всех операций OCR системы с различными уровнями детализации
- Реализовать сбор статистики по использованию OCR функций включая количество обработанных PDF, популярные vision модели
- Добавить мониторинг ошибок OCR системы с автоматическим уведомлением о критических проблемах
- Реализовать создание отчетов по производительности OCR системы
- Добавить мониторинг качества OCR с метриками точности распознавания
- Реализовать систему алертов при превышении пороговых значений производительности
- Обеспечить интеграцию мониторинга OCR с существующей системой логирования приложения

**Ожидаемый результат:** Комплексная система мониторинга и логирования OCR системы с детальными метриками и алертами.

## План поэтапной реализации

### Этап 1: Подготовка инфраструктуры (2-3 дня)
Создание базовых типов и сервисов OCR системы, установка и настройка зависимостей включая библиотеки для работы с изображениями, создание сервиса извлечения изображений из PDF с полным набором типизированных интерфейсов, расширение OllamaApi для поддержки vision моделей.

### Этап 2: Backend интеграция (3-4 дня)
Создание сервиса OCR с интеграцией в OllamaApi, создание утилит для работы с OCR, тестирование OCR обработки и обработки ошибок, оптимизация производительности обработки изображений.

### Этап 3: IPC интеграция (2-3 дня)
Создание IPC обработчиков для OCR системы с обновлением preload скрипта и типов, создание функциональности тестирования OCR IPC API через UI, тестирование IPC коммуникации и обработки ошибок.

### Этап 4: Frontend интеграция (3-4 дня)
Создание UI для выбора vision модели OCR, расширение PDF Viewer для поддержки OCR, создание кастомного TextLayer рендерера для OCR, интеграция OCR режима в существующие компоненты PDF Viewer.

### Этап 5: Оптимизация и производительность (2-3 дня)
Оптимизация обработки изображений для OCR, оптимизация запросов к Ollama для OCR, тестирование производительности с большими PDF документами.

### Этап 6: Интеграция и полировка (2-3 дня)
Полная интеграция всех компонентов OCR системы с тестированием функциональности, реализация управления жизненным циклом OCR данных, создание системы мониторинга и логирования, обработка edge cases и ошибок.

### Этап 7: Тестирование и финализация (2-3 дня)
Комплексное тестирование OCR системы на различных сценариях использования, тестирование производительности с большими PDF документами и различными vision моделями, оптимизация использования памяти и дискового пространства, финальная полировка UI/UX, создание документации для разработчиков и пользователей.

## Технические детали

### Архитектура OCR обработки

**Определение типа PDF:**
Система автоматически определяет тип PDF документа на основе наличия текста в TextLayer. Если текст отсутствует или минимален, PDF считается сканированным и требует OCR обработки. Для смешанных PDF (содержащих и текст, и изображения) система может применять OCR только к страницам без текста.

**Извлечение изображений:**
PDF страницы конвертируются в изображения (PNG/JPEG) с оптимальным разрешением для OCR. Система поддерживает различные DPI для баланса между качеством распознавания и временем обработки. Изображения оптимизируются по размеру перед отправкой в vision модель.

**OCR обработка через Ollama:**
Изображения отправляются в vision модель Ollama (llava, gemma3, qwen3-vl и др.) с промптом, оптимизированным для OCR задач. Vision модель возвращает распознанный текст, который затем структурируется с сохранением координат для построения TextLayer.

**Построение TextLayer:**
Распознанный текст структурируется в формат TextLayer с сохранением координат, размеров шрифта и других метаданных. Кастомный рендерер TextLayer отображает OCR текст в тех же позициях, что и оригинальный текст, обеспечивая совместимость с существующими функциями выделения и перевода.

### Интеграция с react-pdf

**Кастомный TextLayer:**
react-pdf позволяет использовать кастомный рендерер TextLayer через проп `customTextRenderer`. Система использует эту возможность для отображения OCR текста с сохранением координат и структуры.

**Совместимость с существующими функциями:**
OCR текст полностью совместим с существующими функциями PDF Viewer включая выделение текста, перевод, инструкции. Система обеспечивает корректную работу всех функций с OCR текстом.

**Прогрессивная загрузка:**
OCR результаты отображаются по мере обработки страниц, обеспечивая лучший пользовательский опыт при обработке больших PDF документов.

### Оптимизация производительности

**Батчевая обработка:**
Изображения обрабатываются батчами для уменьшения количества запросов к Ollama и ускорения обработки.

**Параллельная обработка:**
Страницы PDF обрабатываются параллельно для максимального использования ресурсов системы.

**Кэширование:**
Результаты OCR кэшируются для избежания повторной обработки одних и тех же документов.

**Оптимизация изображений:**
Изображения оптимизируются по размеру перед отправкой в vision модель для уменьшения времени обработки и нагрузки на систему.

## Возможные проблемы и решения

### Проблема: Высокое потребление памяти при обработке больших PDF документов
**Решение:** Реализовать потоковую обработку PDF документов с загрузкой по страницам, ограничение размера обрабатываемых PDF документов с предупреждениями пользователя, автоматическая очистка памяти при переключении режимов, оптимизация размера изображений в зависимости от доступной памяти, мониторинг использования памяти с автоматическими алертами.

### Проблема: Медленная OCR обработка через Ollama vision модели
**Решение:** Реализовать батчевую обработку изображений для оптимизации запросов к Ollama, кэширование OCR результатов для избежания повторных вычислений, параллельная обработка множественных страниц PDF, оптимизация параметров запросов к Ollama, оптимизация размера изображений перед отправкой в vision модель.

### Проблема: Низкое качество OCR распознавания текста
**Решение:** Реализовать оптимизацию промптов для vision моделей с учетом специфики OCR задач, экспериментирование с различными vision моделями, добавление постобработки распознанного текста для исправления типичных ошибок OCR, реализация валидации качества распознавания с возможностью повторной обработки.

### Проблема: Проблемы с координатами текста в TextLayer
**Решение:** Реализовать точное вычисление координат текста на основе ответа vision модели, добавление валидации координат для предотвращения ошибок позиционирования, реализация автоматической коррекции координат при обнаружении несоответствий, тестирование на различных типах PDF документов.

### Проблема: Совместимость с различными vision моделями Ollama
**Решение:** Реализовать автоматическое определение поддерживаемых vision моделей через фильтрацию по названию содержащему "vision" или "llava", динамическая настройка параметров в зависимости от выбранной модели, fallback механизмы при недоступности выбранной модели с автоматическим переключением на доступную модель, валидация совместимости vision моделей с OCR системой при инициализации, уведомления пользователя о статусе vision модели OCR включая загрузку, ошибки, успешную инициализацию.

### Проблема: Производительность OCR обработки при большом количестве страниц
**Решение:** Реализовать прогрессивную загрузку OCR результатов с отображением по мере обработки, параллельная обработка страниц PDF для максимального использования ресурсов, оптимизация размера изображений для уменьшения времени обработки, кэширование часто используемых OCR результатов, мониторинг производительности OCR обработки с автоматической оптимизацией параметров.

### Проблема: Интеграция OCR текста с существующими функциями PDF Viewer
**Решение:** Обеспечить полную совместимость OCR текста с существующими функциями выделения и перевода через корректное построение TextLayer, тестирование всех функций PDF Viewer с OCR текстом, реализация fallback логики при проблемах с OCR текстом.

## Заключение

Данный план обеспечивает поэтапную реализацию OCR системы с учетом существующей архитектуры проекта Underlator. Архитектура построена на существующих компонентах и принципах проекта, что обеспечивает совместимость и поддерживаемость кода.

Ключевые преимущества реализации:
- Использование существующей инфраструктуры без дублирования функциональности
- Соответствие принципам FSD и Service Layer Architecture
- Безопасность и конфиденциальность данных через локальное хранение
- Интеграция с существующей системой управления моделями и PDF Viewer
- Поддержка различных vision моделей Ollama с автоматическим определением
- Автоматическое определение типа PDF и применение OCR при необходимости
- Полная совместимость OCR текста с существующими функциями PDF Viewer
- Оптимизированная производительность с кэшированием и мониторингом
- Прогрессивная загрузка результатов для улучшения пользовательского опыта
- Расширяемость и возможность добавления новых vision моделей в будущем

