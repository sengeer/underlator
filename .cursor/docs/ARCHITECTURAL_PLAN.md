# Архитектурный план рефакторинга Underlator: Electron + React с интеграцией TypeScript и Ollama

## Общий контекст проекта

**Underlator** - десктопное приложение для конфиденциального перевода и анализа документов с использованием локальных LLM. Архитектура: React (frontend) + Electron (backend).

**Ключевые требования:**
- Работа с чувствительными данными (юристы, врачи, госслужащие)
- Только локальные LLM, никаких внешних HTTP запросов с данными пользователей
- Поддержка зоопарка моделей Ollama
- Полный отказ от @huggingface/transformers
- Прямая интеграция Ollama через HTTP API
- Сохранение Feature-Sliced Design на frontend
- Полная поддержка TypeScript в Electron backend

## Файловая архитектура

### **electron-app/src/**
```
src/
├── main.ts                    # Electron main process (TypeScript)
├── preload.ts                 # Preload script (TypeScript)
├── services/
│   ├── ollama-manager.ts      # Управление Ollama через electron-ollama
│   └── ollama-api.ts          # HTTP клиент для Ollama API
├── types/
│   ├── ollama.types.ts        # Типы для Ollama API
│   ├── models.types.ts        # Типы для моделей
│   └── generation.types.ts    # Типы для генерации
├── utils/
│   ├── ipc-handlers.ts        # IPC обработчики
│   └── error-handler.ts       # Обработка ошибок
└── constants/
    └── ollama.constants.ts    # Константы Ollama
```

### **react-app/src/**
```
src/
├── app/
├── pages/
├── widgets/
│   ├── pdf-viewer/            # Остается как есть
│   ├── text-translator/       # Остается как есть
│   ├── models-manager/        # НОВЫЙ виджет
│   │   ├── ui/
│   │   │   ├── index.tsx      # Главный компонент
│   │   │   ├── model-catalog/ # Каталог моделей
│   │   │   │   ├── index.tsx
│   │   │   │   ├── model-card/
│   │   │   │   └── category-filter/
│   │   │   ├── local-models/  # Локальные модели
│   │   │   │   ├── index.tsx
│   │   │   │   ├── model-item/
│   │   │   │   └── model-actions/
│   │   │   └── model-installer/ # Установка моделей
│   │   │       ├── index.tsx
│   │   │       ├── progress-bar/
│   │   │       └── download-queue/
│   │   └── model/
│   │       ├── store.ts       # Redux slice
│   │       └── hooks.ts       # useModels, useModelInstallation
│   └── settings/              # Обновляется
│       └── ui/
│           ├── index.tsx      # Упрощается
│           ├── provider-selector/ # Выбор провайдера
│           └── model-settings/    # Настройки моделей
├── shared/
│   ├── lib/
│   │   ├── providers/
│   │   │   └── local-ollama/  # НОВЫЙ провайдер
│   │   │       ├── index.ts    # Заменяет local и ollama
│   │   │       ├── types.ts
│   │   │       └── api.ts
│   │   ├── hooks/
│   │   │   ├── use-models/     # Управление моделями
│   │   │   ├── use-ollama/     # Взаимодействие с Ollama
│   │   │   └── use-model-generation/ # Генерация через модели
│   │   └── utils/
│   ├── models/
│   │   ├── models-slice/       # НОВЫЙ slice
│   │   │   ├── index.ts
│   │   │   ├── models-slice.ts
│   │   │   └── types.ts
│   │   ├── ollama-slice/       # НОВЫЙ slice
│   │   │   ├── index.ts
│   │   │   ├── ollama-slice.ts
│   │   │   └── types.ts
│   │   └── provider-settings-slice/ # Обновляется
│   │       ├── index.ts
│   │       └── provider-settings-slice.ts
│   └── ui/
│       ├── model-card/         # Карточка модели
│       ├── progress-bar/       # Прогресс загрузки
│       └── category-filter/    # Фильтр по категориям
```

## Этап 1: Интеграция TypeScript в Electron проект

### 1.1 Установка TypeScript зависимостей и настройка tsconfig.json для Electron backend
**Цель:** Добавить полную поддержку TypeScript в Electron проект с правильной конфигурацией.

**Задачи:**
- Установить typescript, @types/node, @types/electron в package.json
- Создать tsconfig.json с настройками для Electron backend
- Настроить target ES2020, module commonjs, strict mode
- Добавить поддержку decorators и experimental features
- Настроить правильные пути для src/ и dist/

**Ожидаемый результат:** Полностью настроенный TypeScript для Electron backend с правильной конфигурацией компиляции.

### 1.2 Настройка webpack для транспиляции TypeScript в JavaScript
**Цель:** Настроить webpack для корректной работы с TypeScript файлами.

**Задачи:**
- Добавить ts-loader в webpack.config.js
- Настроить правила для .ts и .tsx файлов
- Обновить entry points для main.ts, preload.ts
- Настроить resolve.extensions для TypeScript
- Убедиться что webpack корректно транспилирует TypeScript

**Ожидаемый результат:** Webpack корректно транспилирует TypeScript файлы в JavaScript для Electron.

### 1.3 Миграция существующих JavaScript файлов на TypeScript
**Цель:** Переписать основные файлы Electron на TypeScript с правильной типизацией.

**Задачи:**
- Переименовать main.js в main.ts и добавить типизацию
- Переименовать preload.js в preload.ts и добавить типизацию
- Добавить типы для Electron API и IPC
- Создать интерфейсы для основных структур данных
- Убедиться что все импорты и экспорты корректно типизированы

**Ожидаемый результат:** Основные файлы Electron полностью переписаны на TypeScript с правильной типизацией.

## Этап 2: Создание инфраструктуры для работы с Ollama

### 2.1 Установка electron-ollama и создание OllamaManager для управления Ollama в Electron Main Process
**Цель:** Создать простую систему управления Ollama через electron-ollama библиотеку.

**Задачи:**
- Установить electron-ollama в package.json
- Создать src/services/ollama-manager.ts для управления Ollama
- Реализовать методы initialize(), startOllama(), stopOllama(), isOllamaRunning()
- Настроить автоматическую установку Ollama при первом запуске
- Добавить обработку ошибок и fallback логику

**Ожидаемый результат:** Простая система управления Ollama, которая автоматически устанавливает и запускает Ollama при старте Electron.

### 2.2 Создание HTTP клиента для работы с Ollama API
**Цель:** Создать простой и надежный HTTP клиент для взаимодействия с Ollama API.

**Задачи:**
- Создать src/services/ollama-api.ts для HTTP вызовов к Ollama
- Реализовать методы generate(), installModel(), removeModel(), listModels()
- Добавить поддержку streaming ответов для генерации
- Реализовать простую обработку ошибок и retry логику
- Добавить поддержку AbortController для отмены операций

**Ожидаемый результат:** Надежный HTTP клиент для работы с Ollama API, готовый для использования через IPC.

### 2.3 Создание типов и интерфейсов для Ollama API
**Цель:** Определить четкие типы для всех операций с Ollama API и исправить возникшие TypeScript ошибки.

**Задачи:**
- Испрвить TypeScript ошибки у файлов в electron-app/src/
- Обновить electron-app/src/types/ollama.types.ts с интерфейсами для API
- Создать electron-app/src/types/models.types.ts с типами для моделей
- Создать electron-app/src/types/generation.types.ts с типами для генерации
- Добавить типы для streaming ответов и прогресса
- Создать типы для ошибок и статусов

**Ожидаемый результат:** Полный набор типов для работы с Ollama API, обеспечивающий типобезопасность и отсутствие TypeScript ошибок по проекту.

## Этап 3: Создание IPC системы для взаимодействия с Ollama

### 3.1 Модификация main.ts для запуска Ollama и создания IPC handlers
**Цель:** Создать простую систему IPC для прямого взаимодействия с Ollama HTTP API.

**Задачи:**
- Модифицировать main.ts для запуска Ollama через OllamaManager
- Создать IPC handlers для ollama:generate, models:install, models:remove, models:list
- Интегрировать OllamaApi сервис с IPC handlers
- Добавить обработку ошибок и валидацию входных данных
- Настроить правильную последовательность запуска

**Ожидаемый результат:** Electron main process корректно запускает Ollama и предоставляет IPC API для взаимодействия с frontend.

### 3.2 Создание утилит для обработки IPC сообщений
**Цель:** Создать вспомогательные утилиты для работы с IPC и обработки ошибок.

**Задачи:**
- Создать src/utils/ipc-handlers.ts для централизованной обработки IPC
- Создать src/utils/error-handler.ts для обработки ошибок
- Добавить валидацию IPC сообщений
- Реализовать логирование IPC операций
- Создать утилиты для форматирования ответов

**Ожидаемый результат:** Надежная система обработки IPC сообщений с правильной обработкой ошибок.

### 3.3 Создание констант и конфигурации для Ollama
**Цель:** Централизовать все константы и настройки для Ollama.

**Задачи:**
- Создать src/constants/ollama.constants.ts
- Определить URL endpoints для Ollama API
- Добавить настройки таймаутов и retry попыток
- Создать константы для статусов и ошибок
- Добавить настройки для различных типов моделей

**Ожидаемый результат:** Централизованная конфигурация для всех операций с Ollama.

## Этап 4: Создание нового провайдера local-ollama на frontend

### 4.1 Создание структуры папок shared/lib/providers/local-ollama/
**Цель:** Создать новый провайдер который заменит существующие local и ollama провайдеры.

**Задачи:**
- Создать папку shared/lib/providers/local-ollama/
- Создать index.ts с экспортом localOllamaProvider
- Создать types.ts с типами для нового провайдера
- Создать api.ts с методами для взаимодействия с Electron IPC
- Настроить правильную структуру файлов согласно FSD архитектуре

**Ожидаемый результат:** Полностью готовая структура нового провайдера с правильным размещением файлов.

### 4.2 Реализация localOllamaProvider с единым методом generate
**Цель:** Создать провайдер который работает через Electron IPC и обрабатывает все типы задач.

**Задачи:**
- Реализовать localOllamaProvider.generate() метод
- Добавить поддержку как строк, так и массивов строк
- Интегрировать с window.electron.ollama.generate() через IPC
- Реализовать обработку статусов (progress, message, complete, error)
- Добавить поддержку AbortController для отмены операций
- Реализовать правильную обработку контекстного перевода

**Ожидаемый результат:** Рабочий провайдер который заменяет функциональность существующих local и ollama провайдеров.

### 4.3 Обновление системы провайдеров
**Цель:** Интегрировать новый провайдер в существующую систему провайдеров.

**Задачи:**
- Обновить shared/lib/providers/index.ts
- Добавить local-ollama в список провайдеров
- Обновить ProviderType для включения 'local-ollama'
- Обновить getModelUseProvider функцию
- Подготовить к удалению старых провайдеров

**Ожидаемый результат:** Система провайдеров работает с новым local-ollama провайдером.

## Этап 5: Создание React компонентов для управления моделями

### 5.1 Создание виджета models-manager с базовой структурой
**Цель:** Создать новый виджет для управления моделями согласно FSD архитектуре.

**Задачи:**
- Создать папку widgets/models-manager/ с подпапками ui/, model/
- Создать ui/index.tsx как главный компонент виджета
- Создать model/store.ts для Redux slice управления моделями
- Создать model/hooks.ts для кастомных хуков
- Создать папки для подкомпонентов
- Настроить правильную структуру согласно FSD принципам

**Ожидаемый результат:** Полностью готовая структура виджета models-manager с правильным размещением файлов.

### 5.2 Реализация Redux slice для управления моделями
**Цель:** Создать централизованное управление состоянием моделей.

**Задачи:**
- Создать models-slice.ts с initialState для каталога, локальных моделей, процесса установки
- Добавить reducers для setCatalog, setLocalModels, setInstallationProgress
- Реализовать async thunks для fetchCatalog, fetchLocalModels, installModel, removeModel
- Добавить обработку состояний loading, error, success для каждой операции
- Реализовать правильную структуру состояния согласно FSD принципам

**Ожидаемый результат:** Полнофункциональный Redux slice для управления всеми аспектами работы с моделями.

### 5.3 Создание подкомпонентов для управления моделями
**Цель:** Реализовать пользовательский интерфейс для всех операций с моделями.

**Задачи:**
- Создать model-catalog/ для отображения каталога моделей
- Создать local-models/ для отображения установленных моделей
- Создать model-installer/ для процесса установки моделей
- Реализовать model-card/ компонент для отображения информации о модели
- Добавить category-filter/ для фильтрации моделей
- Реализовать progress-bar/ для отображения процесса загрузки

**Ожидаемый результат:** Полнофункциональный UI для управления моделями с возможностью просмотра каталога, установки и управления локальными моделями.

## Этап 6: Интеграция с существующими компонентами

### 6.1 Модификация useModel хука для работы с новым провайдером
**Цель:** Обновить основной хук для работы с новым провайдером и поддержки выбора моделей.

**Задачи:**
- Модифицировать useModel для использования 'local-ollama' провайдера
- Добавить поддержку выбора модели из списка доступных
- Обновить generate() метод для передачи параметров модели
- Добавить поддержку параметров генерации (temperature, maxTokens)
- Интегрировать с новым Redux store для моделей
- Сохранить существующую логику для контекстного перевода

**Ожидаемый результат:** Обновленный useModel хук который работает с новым провайдером и поддерживает выбор моделей.

### 6.2 Обновление Settings компонента
**Цель:** Интегрировать новый models-manager в Settings и упростить интерфейс.

**Задачи:**
- Интегрировать models-manager виджет в Settings компонент
- Упростить интерфейс настроек, убрав старые элементы управления моделями
- Добавить выбор провайдера 'local-ollama' как единственного варианта
- Интегрировать с новым Redux store для моделей
- Обновить логику отображения статуса моделей
- Упростить UI, оставив только необходимые элементы

**Ожидаемый результат:** Обновленный Settings компонент с интеграцией нового models-manager.

### 6.3 Обновление других виджетов
**Цель:** Обеспечить корректную работу всех виджетов с новым провайдером.

**Задачи:**
- Обновить pdf-viewer для работы с 'local-ollama' провайдером
- Обновить text-translator для работы с новым провайдером
- Добавить поддержку выбора модели в интерфейсе
- Убедиться что контекстный перевод работает корректно
- Обновить логику обработки ошибок и статусов
- Протестировать все сценарии использования

**Ожидаемый результат:** Все виджеты корректно работают с новым провайдером.

## Этап 7: Удаление старых провайдеров и зависимостей

### 7.1 Удаление старых провайдеров
**Цель:** Полностью очистить проект от старых провайдеров и их кода.

**Задачи:**
- Удалить shared/lib/providers/local/ папку полностью
- Удалить shared/lib/providers/ollama/ папку полностью
- Удалить shared/apis/ollama/ папку
- Обновить shared/lib/providers/index.ts
- Удалить ProviderType 'Electron IPC' и 'Ollama'
- Обновить все импорты и ссылки

**Ожидаемый результат:** Проект полностью очищен от старых провайдеров.

### 7.2 Удаление @huggingface/transformers
**Цель:** Убрать все упоминания и использование @huggingface/transformers.

**Задачи:**
- Удалить @huggingface/transformers из package.json
- Удалить src/model.js файл полностью
- Удалить src/worker.js файл полностью
- Удалить src/services/model-downloader.js файл полностью
- Обновить main.ts, убрав все ссылки на старые сервисы
- Удалить все импорты и использование старых модулей

**Ожидаемый результат:** Electron backend полностью очищен от @huggingface/transformers.

### 7.3 Очистка зависимостей
**Цель:** Оптимизировать зависимости и упростить процесс сборки.

**Задачи:**
- Удалить неиспользуемые зависимости из package.json
- Обновить скрипты сборки для работы с TypeScript
- Проверить и обновить все devDependencies
- Убедиться что сборка работает корректно

**Ожидаемый результат:** Оптимизированный package.json с правильными зависимостями для TypeScript.

## Этап 8: Тестирование и финальная оптимизация

### 8.1 Комплексное тестирование системы
**Цель:** Убедиться что все компоненты системы работают корректно вместе.

**Задачи:**
- Протестировать запуск Ollama через electron-ollama в Electron
- Проверить корректность IPC коммуникации между frontend и backend
- Протестировать работу нового local-ollama провайдера
- Проверить корректность контекстного перевода
- Протестировать установку и удаление моделей через Ollama API
- Проверить работу с различными типами задач
- Протестировать UI компоненты для управления моделями

**Ожидаемый результат:** Полностью рабочая система с корректной интеграцией всех компонентов.

### 8.2 Финальная оптимизация и настройка
**Цель:** Оптимизировать систему и убедиться в соблюдении требований безопасности.

**Задачи:**
- Проверить отсутствие внешних HTTP запросов с данными пользователей
- Оптимизировать производительность генерации через Ollama HTTP API
- Настроить правильные параметры для различных типов моделей
- Проверить корректность работы с большими документами
- Оптимизировать UI для лучшего пользовательского опыта
- Провести финальное тестирование всех сценариев использования
- Убедиться в правильной работе TypeScript и IPC системы

**Ожидаемый результат:** Оптимизированная, безопасная и производительная система с полной поддержкой TypeScript.

## Ключевые принципы архитектуры

✅ **TypeScript поддержка** - полная типизация Electron backend
✅ **Прямая интеграция** - React → IPC → Electron → HTTP → Ollama
✅ **Простота** - понятная архитектура без лишних слоев
✅ **Производительность** - меньше hop'ов, быстрее работа
✅ **Красивый UI** - современные компоненты для управления моделями
✅ **FSD compliance** - строгое соблюдение Feature-Sliced Design
✅ **Безопасность** - полная конфиденциальность данных

## Ожидаемый результат

После завершения всех этапов у вас будет:
- **TypeScript backend** - полностью типизированный Electron backend
- **Упрощенная архитектура** - Electron + React с прямой интеграцией Ollama
- **Высокая производительность** - нативные Ollama модели через HTTP API
- **Красивый UI** - современные компоненты для управления моделями
- **Масштабируемость** - легко добавлять новые модели и возможности
- **Безопасность** - полная конфиденциальность данных
- **User-friendly** - автоматическая установка и красивое управление моделями

Каждый этап можно делегировать отдельному агенту, который получит детальные инструкции и сможет выполнить задачу качественно.